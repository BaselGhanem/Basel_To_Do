<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Basel Productivity | Quantum Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Tajawal:wght@300;400;500;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. ARCHITECTURAL VARIABLES (Design Tokens) --- */
        :root {
            --hue-primary: 250;
            --primary: hsl(var(--hue-primary), 90%, 65%);
            --primary-dark: hsl(var(--hue-primary), 80%, 55%);
            --primary-glow: hsla(var(--hue-primary), 90%, 65%, 0.4);
            
            --hue-accent: 320;
            --accent: hsl(var(--hue-accent), 90%, 60%);
            
            --success: #00dbb5;
            --danger: #ff4b4b;
            --warning: #fbbf24;

            --bg-deep: #030712;
            --bg-mesh-1: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%);
            --bg-mesh-2: radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%);
            --bg-mesh-3: radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            
            --glass-surface: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.1);
            
            --font-main: 'Inter', sans-serif;
            --font-ar: 'Tajawal', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --text-dim: #475569;

            --ease-elastic: cubic-bezier(0.68, -0.6, 0.32, 1.6);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --duration-fast: 0.2s;
            --duration-norm: 0.4s;
            
            --shadow-card: 0 20px 40px -15px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 20px var(--primary-glow);

            /* Sidebar Variables */
            --sidebar-width: 80px;
        }

        [data-theme="light"] {
            --bg-deep: #f8fafc;
            --glass-surface: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(0, 0, 0, 0.05);
            --text-main: #0f172a;
            --text-muted: #64748b;
            --primary: hsl(var(--hue-primary), 80%, 55%);
            --bg-mesh-1: radial-gradient(at 0% 0%, hsla(210, 100%, 96%, 1) 0, transparent 50%);
            --bg-mesh-2: transparent;
            --bg-mesh-3: transparent;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            background-image: var(--bg-mesh-1), var(--bg-mesh-2), var(--bg-mesh-3);
            background-size: 200% 200%;
            animation: meshFlow 20s ease infinite alternate;
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        [dir="rtl"] body { font-family: var(--font-ar); }
        
        @keyframes meshFlow { 0% { background-position: 0% 0%; } 100% { background-position: 100% 100%; } }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: var(--text-muted); 
            border-radius: 10px; 
            border: 2px solid transparent;
            background-clip: content-box;
        }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-card);
        }
        .interactive { cursor: pointer; transition: transform var(--duration-fast) var(--ease-smooth), box-shadow var(--duration-fast); }
        .interactive:active { transform: scale(0.96); }

        .spotlight-card { position: relative; overflow: hidden; }
        .spotlight-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(800px circle at var(--mouse-x) var(--mouse-y), rgba(255,255,255,0.06), transparent 40%);
            z-index: 1; pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        .spotlight-card:hover::before { opacity: 1; }

        #app-root {
            display: grid; grid-template-columns: var(--sidebar-width) 1fr; height: 100vh;
            max-width: 1920px; margin: 0 auto;
            transition: grid-template-columns 0.4s var(--ease-elastic);
        }
        #app-root.expanded { --sidebar-width: 240px; }
        
        aside {
            display: flex; flex-direction: column; align-items: center; padding: 2rem 0;
            border-right: 1px solid var(--glass-border); z-index: 10;
        }
        .brand-logo { 
            font-size: 1.5rem; font-weight: 800; margin-bottom: 0.5rem; 
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        .nav-item {
            width: 45px; height: 45px; border-radius: 14px; display: flex; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 1.2rem; margin-bottom: 1rem; transition: var(--duration-norm);
            position: relative; overflow: hidden;
        }
        .nav-item.active { background: var(--primary); color: white; box-shadow: var(--shadow-glow); }
        .nav-item:hover:not(.active) { background: rgba(255,255,255,0.05); color: var(--text-main); }
        
        /* Sidebar Text & Expansion */
        .nav-text {
            opacity: 0; width: 0; overflow: hidden; white-space: nowrap;
            transition: 0.3s var(--ease-smooth); margin-left: 0;
            font-size: 0.95rem; font-weight: 500;
        }
        #app-root.expanded .nav-text { opacity: 1; width: auto; margin-left: 15px; }
        #app-root.expanded .nav-item { justify-content: flex-start; padding-left: 12px; width: 90%; }
        
        .toggle-btn {
            width: 30px; height: 30px; border-radius: 8px; background: rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            margin-bottom: 2rem; transition: 0.3s; color: var(--text-muted);
        }
        .toggle-btn:hover { background: var(--primary); color: white; }

        /* Tooltips only on desktop when collapsed */
        @media (min-width: 769px) {
            #app-root:not(.expanded) .nav-item[data-tooltip]:hover::after {
                content: attr(data-tooltip); position: absolute; left: 60px; 
                background: var(--bg-deep); padding: 5px 10px; border-radius: 6px; 
                font-size: 0.8rem; border: 1px solid var(--glass-border); white-space: nowrap;
                animation: fadeIn 0.2s forwards; z-index: 100;
            }
        }

        main { position: relative; overflow: hidden; height: 100%; display: flex; flex-direction: column; }
        header { 
            padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; 
            background: linear-gradient(to bottom, rgba(3,7,18,0.8), transparent);
        }
        .user-profile { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .avatar { 
            width: 36px; height: 36px; background: linear-gradient(135deg, #FF9A9E, #FECFEF); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: #333; font-size: 0.9rem; border: 2px solid rgba(255,255,255,0.2);
        }

        .view-container { 
            flex: 1; padding: 0 2rem 2rem; overflow-y: auto; 
            position: absolute; inset: 0; top: 80px;
            opacity: 0; transform: translateY(20px) scale(0.98); pointer-events: none;
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .view-container.active { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }

        .bento-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;
            padding-bottom: 100px;
        }
        
        .stats-widget {
            grid-column: 1 / -1; padding: 2rem; border-radius: 24px;
            display: flex; justify-content: space-between; align-items: flex-end;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.05));
            border: 1px solid var(--primary-glow); position: relative; overflow: hidden;
        }
        .quote-box { max-width: 60%; font-style: italic; color: var(--text-muted); font-size: 0.95rem; }
        .quote-author { display: block; margin-top: 5px; font-weight: 600; font-style: normal; color: var(--primary); }

        .folder-card {
            height: 180px; border-radius: 24px; padding: 1.5rem;
            display: flex; flex-direction: column; justify-content: space-between;
            transition: all 0.4s var(--ease-elastic); position: relative;
        }
        .folder-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 30px var(--primary-glow); z-index: 2; }
        .folder-info h3 { font-size: 1.4rem; margin-bottom: 0.2rem; }
        .folder-info span { font-size: 0.85rem; opacity: 0.7; }
        
        .progress-bar-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 10px; transition: width 1s ease 0.5s; width: 0; }

        .task-view-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; }
        .task-columns { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; padding-bottom: 4rem; }
        .task-col-header { 
            position: sticky; top: 0; background: var(--bg-deep); z-index: 5; padding: 1rem 0; 
            font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid var(--glass-border);
        }
        
        .task-item {
            padding: 1rem; border-radius: 16px; margin-bottom: 0.8rem;
            background: var(--glass-surface); border: 1px solid var(--glass-border);
            display: flex; align-items: center; gap: 1rem;
            transition: all 0.3s var(--ease-smooth); animation: slideUp 0.4s ease backwards;
        }
        .task-item:hover { background: rgba(255,255,255,0.06); transform: translateX(5px); border-color: var(--glass-highlight); }
        .task-item.completed { opacity: 0.5; filter: grayscale(1); }
        .task-item.completed h4 { text-decoration: line-through; }
        
        .checkbox {
            width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--text-muted);
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; min-width: 22px;
        }
        .task-item.completed .checkbox { background: var(--success); border-color: var(--success); color: #000; animation: pop 0.3s; }
        
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; background: rgba(255,255,255,0.05); }
        .tag.urgent { color: var(--danger); background: rgba(255, 75, 75, 0.1); border: 1px solid rgba(255, 75, 75, 0.2); }

        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-backdrop.open { opacity: 1; pointer-events: all; }
        .modal-window {
            width: 90%; max-width: 500px; padding: 2.5rem; border-radius: 32px;
            transform: scale(0.9) translateY(20px); transition: 0.4s var(--ease-elastic);
            background: #1e293b; border: 1px solid var(--glass-highlight);
        }
        .modal-backdrop.open .modal-window { transform: scale(1) translateY(0); }
        
        input, select {
            width: 100%; padding: 1rem; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border);
            border-radius: 12px; color: var(--text-main); margin-bottom: 1rem;
            transition: 0.3s; font-family: var(--font-main);
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); background: rgba(0,0,0,0.4); }

        .btn-main {
            width: 100%; padding: 1rem; border-radius: 14px; border: none; font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent)); color: white;
            cursor: pointer; position: relative; overflow: hidden; letter-spacing: 0.5px;
        }
        .btn-main::after {
            content: ''; position: absolute; inset: 0; background: rgba(255,255,255,0.2);
            transform: translateX(-100%); transition: 0.3s;
        }
        .btn-main:hover::after { transform: translateX(0); }

        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; align-items: center; }
        .toast {
            padding: 12px 24px; border-radius: 50px; background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px); border: 1px solid var(--glass-border);
            color: white; font-size: 0.9rem; display: flex; align-items: center; gap: 10px;
            animation: slideUpFade 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); white-space: nowrap;
        }

        .fab {
            position: fixed; bottom: 40px; right: 40px; width: 64px; height: 64px;
            background: var(--text-main); color: var(--bg-deep); border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 2rem;
            cursor: pointer; z-index: 100; box-shadow: 0 10px 30px -5px rgba(255,255,255,0.3);
            transition: 0.4s var(--ease-elastic);
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .cal-nav-btn { background: var(--glass-surface); border: 1px solid var(--glass-border); color: var(--text-main); width: 40px; height: 40px; border-radius: 12px; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; }
        .cal-nav-btn:hover { background: var(--primary); color: white; box-shadow: var(--shadow-glow); }
        
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .cal-day-name { text-align: center; font-weight: 700; color: var(--text-muted); font-size: 0.8rem; padding-bottom: 10px; text-transform: uppercase; }
        
        .cal-cell { 
            min-height: 100px; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid transparent;
            padding: 10px; display: flex; flex-direction: column; gap: 5px; transition: 0.2s; cursor: pointer; position: relative;
        }
        .cal-cell:hover { background: rgba(255,255,255,0.08); transform: translateY(-3px); border-color: var(--glass-highlight); }
        .cal-cell.today { background: rgba(99, 102, 241, 0.15); border: 1px solid var(--primary); box-shadow: inset 0 0 20px rgba(99, 102, 241, 0.2); }
        .cal-cell.empty { background: transparent; pointer-events: none; }
        
        .cal-date-num { font-weight: 700; font-size: 0.9rem; margin-bottom: 5px; opacity: 0.7; }
        
        .task-dot { 
            font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; 
            background: rgba(255,255,255,0.1); border-left: 3px solid var(--primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            animation: fadeIn 0.3s;
        }
        .task-dot.done { text-decoration: line-through; opacity: 0.5; border-color: var(--success); }
        .task-dot.urgent { border-color: var(--danger); background: rgba(255, 75, 75, 0.1); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        /* --- MOBILE ENHANCEMENTS --- */
        @media (max-width: 768px) {
            #app-root { grid-template-columns: 1fr; grid-template-rows: 1fr 70px; }
            aside { 
                flex-direction: row; order: 2; width: 100%; height: 70px; border-right: none; border-top: 1px solid var(--glass-border);
                justify-content: space-evenly; padding: 0 10px; background: var(--bg-deep); position: fixed; bottom: 0; 
                backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            }
            .brand-logo, .toggle-btn, .nav-text { display: none !important; }
            .nav-item { margin-bottom: 0; width: auto; flex: 1; height: 100%; border-radius: 0; background: transparent !important; box-shadow: none !important; padding: 0 !important; }
            .nav-item.active { color: var(--primary); }
            .nav-item svg { width: 28px; height: 28px; } 

            main { order: 1; height: calc(100vh - 70px); padding-bottom: 0; }
            header { padding: 1rem 1.5rem; }
            
            .view-container { padding: 0 1rem 1rem; top: 70px; overflow-x: hidden; }
            .fab { bottom: 90px; right: 20px; width: 56px; height: 56px; }

            .bento-grid { grid-template-columns: 1fr; gap: 1rem; padding-bottom: 80px; }
            
            .stats-widget { flex-direction: column; align-items: flex-start; gap: 1rem; padding: 1.5rem; }
            .quote-box { max-width: 100%; font-size: 0.85rem; }
            .stats-widget > div:last-child { align-self: flex-end; }
            
            .task-view-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .task-view-header div:last-child { width: 100%; }
            #task-search { width: 100% !important; font-size: 1rem; padding: 0.8rem; }
            
            .task-columns { grid-template-columns: 1fr; gap: 2rem; padding-bottom: 6rem; }
            
            .task-item { padding: 0.8rem; }
            .task-item h4 { font-size: 0.95rem; }
            
            .modal-window { width: 95%; padding: 1.5rem; max-height: 85vh; overflow-y: auto; }
            
            .cal-grid { gap: 4px; }
            .cal-day-name { font-size: 0.7rem; }
            .cal-cell { min-height: 50px; padding: 4px; border-radius: 8px; }
            .cal-date-num { font-size: 0.8rem; margin-bottom: 2px; }
            .cal-cell .task-dot { 
                width: 6px; height: 6px; padding: 0; border: none; border-radius: 50%; 
                display: inline-block; margin: 1px; text-indent: -9999px; 
            }
            .cal-cell .task-dot.urgent { background-color: var(--danger); }
            .cal-cell .task-dot:not(.urgent) { background-color: var(--primary); }
            
            #toast-container { bottom: 85px; }
        }
    </style>
</head>
<body onload="QuantumApp.init()">

    <div id="login-screen" style="position:fixed; inset:0; z-index:9999; background:var(--bg-deep); display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div class="glass-panel" style="padding:3rem; border-radius:30px; width:90%; max-width:400px; text-align:center;">
            <h1 class="brand-logo" style="margin-bottom:0.5rem; font-size:2.5rem; display:block;">Basel</h1>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Quantum Edition</p>
            <input type="text" id="username" placeholder="Identity" value="Basel" style="text-align:center;">
            <input type="password" id="password" placeholder="Passcode" style="text-align:center;">
            <button class="btn-main" onclick="QuantumApp.login()">AUTHENTICATE</button>
        </div>
    </div>

    <div id="app-root" class="hidden">
        <aside class="glass-panel" style="border-radius:0;">
            <div style="display:flex; flex-direction:column; align-items:center; width:100%; margin-bottom:1rem;">
                <div class="brand-logo">T</div>
                <div class="toggle-btn" onclick="QuantumApp.toggleSidebar()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/></svg>
                </div>
            </div>
        
            <div class="nav-item active" onclick="Router.nav('home')" data-tooltip="Overview">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                <span class="nav-text">Overview</span>
            </div>
            
            <div class="nav-item" onclick="Router.nav('calendar')" data-tooltip="Timeline">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                <span class="nav-text">Timeline</span>
            </div>
            
            <div class="nav-item" onclick="CalendarSync.execute()" data-tooltip="Sync to Calendar" style="color: var(--success);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                <span class="nav-text">Sync Cal</span>
            </div>
        
            <div class="nav-item" onclick="DataSync.export()" data-tooltip="Backup Data">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                <span class="nav-text">Backup</span>
            </div>
        
            <div class="nav-item" onclick="document.getElementById('import-file').click()" data-tooltip="Restore Data">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 14 15 14 15 20"></polyline><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="14"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                <input type="file" id="import-file" style="display:none" onchange="DataSync.import(event)" accept=".json">
                <span class="nav-text">Restore</span>
            </div>
            
            <div style="flex:1;"></div>
            
            <div class="nav-item" onclick="QuantumApp.resetData()" data-tooltip="Reset System" style="color:#ff4b4b;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                <span class="nav-text">Reset</span>
            </div>
        
            <div class="nav-item" onclick="QuantumApp.toggleTheme()" data-tooltip="Theme">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <span class="nav-text">Theme</span>
            </div>
            
            <div class="nav-item" onclick="QuantumApp.logout()" data-tooltip="Logout">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span class="nav-text">Logout</span>
            </div>
        </aside>

        <main>
            <header>
                <div>
                    <h2 id="greeting-txt" style="font-size:1.5rem; font-weight:700;">Good Morning</h2>
                    <p style="color:var(--text-muted); font-size:0.9rem;" id="date-display">Monday, Oct 24</p>
                </div>
                <div class="user-profile interactive" onclick="NotificationSys.show('Profile Settings Locked')">
                    <div style="text-align:right;">
                        <div style="font-weight:600; font-size:0.9rem;" id="user-name-disp">Basel</div>
                        <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">Elite</div>
                    </div>
                    <div class="avatar">B</div>
                </div>
            </header>

            <div id="view-home" class="view-container active">
                <div class="bento-grid">
                    <div class="stats-widget glass-panel spotlight-card">
                        <div>
                            <div class="quote-box">"Efficiency is doing things right; effectiveness is doing the right things."</div>
                            <span class="quote-author">- Peter Drucker</span>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:3rem; font-weight:800; line-height:1; color:var(--primary);" id="total-percent">0%</div>
                            <div style="color:var(--text-muted); font-size:0.9rem;">Weekly Efficiency</div>
                        </div>
                    </div>
                    <div id="folders-mount" style="display:contents;"></div>
                </div>
            </div>

            <div id="view-tasks" class="view-container">
                <div class="task-view-header">
                    <button class="interactive" onclick="Router.nav('home')" style="background:none; border:none; color:var(--text-main); font-size:1.5rem; cursor:pointer;">←</button>
                    <h1 id="folder-title" style="font-weight:800; font-size:2rem;">Folder Name</h1>
                    <div style="margin-left:auto;">
                        <input type="text" id="task-search" placeholder="Search missions..." style="width:200px; padding:0.5rem 1rem; margin:0; font-size:0.9rem;" onkeyup="Tasks.search(this.value)">
                    </div>
                </div>
                <div class="task-columns">
                    <div>
                        <div class="task-col-header">Today's Missions</div>
                        <div id="list-today"></div>
                    </div>
                    <div>
                        <div class="task-col-header">Upcoming & Backlog</div>
                        <div id="list-longterm"></div>
                    </div>
                </div>
            </div>

            <div id="view-calendar" class="view-container">
                <div class="cal-header">
                    <h1 id="cal-title" style="background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Timeline</h1>
                    <div style="display:flex; gap:10px;">
                        <button class="cal-nav-btn" onclick="Calendar.nav(-1)">❮</button>
                        <button class="cal-nav-btn" onclick="Calendar.nav(0)">●</button>
                        <button class="cal-nav-btn" onclick="Calendar.nav(1)">❯</button>
                    </div>
                </div>
                <div class="glass-panel spotlight-card" style="padding:1.5rem; border-radius:32px;">
                    <div class="cal-grid" id="cal-grid-mount"></div>
                </div>
            </div>
        </main>
    </div>

    <div class="fab interactive hidden" id="main-fab" onclick="Modal.open()">+</div>

    <div class="modal-backdrop" id="modal-overlay" onclick="if(event.target === this) Modal.close()">
        <div class="modal-window glass-panel">
            <h2 style="margin-bottom:1.5rem;">New Objective</h2>
            <input type="text" id="inp-title" placeholder="What needs to be done?" autofocus>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="inp-folder"></select>
                <select id="inp-type" onchange="if(this.value==='today') document.getElementById('inp-date').value = new Date().toISOString().split('T')[0]">
                    <option value="today">Today</option>
                    <option value="longterm">Later</option>
                </select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="date" id="inp-date">
                <input type="time" id="inp-time">
            </div>
            <div style="display:flex; gap:10px; margin-bottom:1.5rem; align-items:center;">
                <input type="checkbox" id="inp-urgent" style="width:auto; margin:0;">
                <label for="inp-urgent" style="color:var(--text-muted); font-size:0.9rem;">Mark as High Priority</label>
            </div>
            <button class="btn-main" onclick="Tasks.save()">INITIATE MISSION</button>
        </div>
    </div>

    <div id="toast-container"></div>
    <div id="excel-controls" style="display:none;">
        <input type="file" id="excel-import-file" accept=".csv, .xlsx, .xls" onchange="QuantumExcel.import(event)" style="display:none;">
    </div>
    <canvas id="confetti" style="position:fixed; inset:0; pointer-events:none; z-index:2000;"></canvas>

<script>
    const CONFIG = { user: 'Basel', pass: '2505', dbKey: 'Basel_quantum_v1' };

    const DB = {
        get: () => JSON.parse(localStorage.getItem(CONFIG.dbKey)) || { tasks: [] },
        set: (data) => localStorage.setItem(CONFIG.dbKey, JSON.stringify(data)),
        init: () => { if(!localStorage.getItem(CONFIG.dbKey)) DB.set({ tasks: [] }); }
    };

    // --- CALENDAR SYNC LOGIC ---
    const CalendarSync = {
        execute: () => {
            const tasks = DB.get().tasks.filter(t => !t.completed);
            if(tasks.length === 0) return NotificationSys.show('No active tasks to sync', 'info');

            let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Basel Productivity//Quantum Edition//EN\n";
            
            tasks.forEach(task => {
                if(!task.dueDate) return;
                const dateStr = task.dueDate.replace(/-/g, '');
                const timeStr = task.time ? task.time.replace(/:/g, '') + "00" : "090000"; 
                const dtStart = `${dateStr}T${timeStr}`;
                const dtEnd = `${dateStr}T${parseInt(timeStr.substring(0,2)) + 1}${timeStr.substring(2)}`; 
                
                icsContent += "BEGIN:VEVENT\n";
                icsContent += `SUMMARY:${task.title}\n`;
                icsContent += `DTSTART:${dtStart}\n`;
                icsContent += `DTEND:${dtEnd}\n`;
                icsContent += `DESCRIPTION:Priority: ${task.urgent ? 'High' : 'Normal'} | Folder: ${task.folder}\n`;
                icsContent += "END:VEVENT\n";
            });
            
            icsContent += "END:VCALENDAR";

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'basel_missions.ics');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            NotificationSys.show('Calendar File Generated', 'success');
        }
    };

    const DataSync = {
        export: () => {
            const data = localStorage.getItem(CONFIG.dbKey);
            if (!data || JSON.parse(data).tasks.length === 0) {
                return NotificationSys.show('No data to export, Commander.', 'error');
            }
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Basel_Quantum_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            NotificationSys.show('Data Exported Successfully', 'success');
        },
        import: (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.tasks && Array.isArray(importedData.tasks)) {
                        if (confirm('Importing will overwrite current data. Proceed?')) {
                            DB.set(importedData);
                            NotificationSys.show('System Synchronized', 'success');
                            setTimeout(() => location.reload(), 1000);
                        }
                    } else { throw new Error(); }
                } catch { NotificationSys.show('Invalid Backup File', 'error'); }
            };
            reader.readAsText(file);
        }
    };

    const FX = {
        confetti: () => {
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            let particles = [];
            for(let i=0; i<100; i++) particles.push({x: window.innerWidth/2, y: window.innerHeight/2, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, color: `hsl(${Math.random()*360}, 100%, 50%)`, life: 100});
            function draw() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles.forEach((p,i) => { p.x += p.vx; p.y += p.vy; p.life--; p.vy += 0.2; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 5, 5); if(p.life <= 0) particles.splice(i,1); });
                if(particles.length > 0) requestAnimationFrame(draw);
            }
            draw();
        },
        trackMouse: (e) => {
            document.querySelectorAll('.spotlight-card').forEach(card => {
                const rect = card.getBoundingClientRect();
                card.style.setProperty('--mouse-x', `${e.clientX - rect.left}px`);
                card.style.setProperty('--mouse-y', `${e.clientY - rect.top}px`);
            });
        }
    };

    const NotificationSys = {
        show: (msg, type='info') => {
            const con = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerHTML = `<span>${type==='success'?'✅': type==='error'?'⚠️':'ℹ️'}</span> ${msg}`;
            con.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(20px)'; setTimeout(() => el.remove(), 500); }, 3000);
        }
    };

    const QuantumApp = {
        state: { folder: null, editingId: null },
        init: () => {
            DB.init();
            if(sessionStorage.getItem('Basel_session')) QuantumApp.unlockUI();
            document.addEventListener('mousemove', FX.trackMouse);
            document.addEventListener('keydown', (e) => {
                if(e.ctrlKey && e.key === 'k') { e.preventDefault(); document.getElementById('task-search')?.focus(); }
                if(e.key === 'Escape') Modal.close();
            });
            const hour = new Date().getHours();
            document.getElementById('greeting-txt').innerText = `${hour < 12 ? 'Good Morning' : hour < 18 ? 'Good Afternoon' : 'Good Evening'}, ${CONFIG.user}`;
            document.getElementById('date-display').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            Tasks.updateGlobalStats();
        },
        login: () => {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if((u === CONFIG.user && p === CONFIG.pass) || (u && p)) { sessionStorage.setItem('Basel_session', u); QuantumApp.unlockUI(); NotificationSys.show('Access Granted.', 'success'); } 
            else { NotificationSys.show('Access Denied', 'error'); }
        },
        unlockUI: () => {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-root').classList.remove('hidden');
            document.getElementById('main-fab').classList.remove('hidden');
            Router.nav('home');
        },
        resetData: () => {
            if(confirm('⚠️ Factory Reset? All data will be lost.')) { localStorage.removeItem(CONFIG.dbKey); location.reload(); }
        },
        logout: () => { sessionStorage.removeItem('Basel_session'); location.reload(); },
        toggleTheme: () => { const current = document.body.getAttribute('data-theme'); document.body.setAttribute('data-theme', current === 'light' ? 'dark' : 'light'); },
        
        // --- ADDED: Sidebar Toggle Logic ---
        toggleSidebar: () => {
            const app = document.getElementById('app-root');
            const btn = document.querySelector('.toggle-btn svg');
            app.classList.toggle('expanded');
            if(app.classList.contains('expanded')) {
                btn.innerHTML = '<path d="M13 5l7 7-7 7M5 12h14"/>'; 
            } else {
                btn.innerHTML = '<path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>'; 
            }
        }
    };

    const Router = {
        nav: (view) => {
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const items = document.querySelectorAll('.nav-item');
            
            // Basic routing (Overridden by QuantumExtensions for 'myday')
            if(view === 'home') {
                QuantumApp.state.folder = null; 
                document.getElementById('view-home').classList.add('active');
                // Index 0 in nav list (Overview)
                items[0].classList.add('active');
                Tasks.renderFolders();
                Tasks.updateGlobalStats();
            } else if(view === 'calendar') {
                document.getElementById('view-calendar').classList.add('active');
                items[1].classList.add('active');
                Calendar.render();
            }
        },
        openFolder: (folderName) => {
            QuantumApp.state.folder = folderName;
            document.getElementById('view-home').classList.remove('active');
            document.getElementById('view-tasks').classList.add('active');
            document.getElementById('folder-title').innerText = folderName;
            Tasks.renderList();
        }
    };

    const Tasks = {
        folders: ['X Academy', 'Personal', 'Work', 'Development'],
        getFormattedDate: (dateStr) => {
            if(!dateStr) return '';
            const diff = Math.ceil((new Date(dateStr) - new Date().setHours(0,0,0,0)) / (1000 * 60 * 60 * 24)); 
            return diff === 0 ? 'Today' : diff === 1 ? 'Tomorrow' : dateStr;
        },
        updateGlobalStats: () => {
            const all = DB.get().tasks;
            const total = all.length;
            const completed = all.filter(t => t.completed).length;
            const el = document.getElementById('total-percent');
            if(el) el.innerText = `${total === 0 ? 0 : Math.round((completed / total) * 100)}%`;
        },
        renderFolders: () => {
            const mount = document.getElementById('folders-mount');
            mount.innerHTML = '';
            const data = DB.get().tasks;
            Tasks.folders.forEach((f, index) => {
                const tList = data.filter(t => t.folder === f);
                const total = tList.length;
                const percent = total === 0 ? 0 : Math.round((tList.filter(t => t.completed).length/total)*100);
                const card = document.createElement('div');
                card.className = 'folder-card glass-panel spotlight-card interactive';
                card.style.animation = `slideUp 0.5s var(--ease-elastic) ${index * 0.1}s backwards`;
                const hue = 200 + (index * 40);
                const gradient = `linear-gradient(135deg, hsl(${hue}, 80%, 60%), hsl(${hue+30}, 80%, 60%))`;
                card.innerHTML = `
                    <div class="folder-info"><div style="width:40px; height:40px; border-radius:10px; background:${gradient}; display:flex; align-items:center; justify-content:center; margin-bottom:1rem;"><svg width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg></div><h3>${f}</h3><span>${total} Missions</span></div>
                    <div><div style="display:flex; justify-content:space-between; font-size:0.8rem; font-weight:700;"><span>Progress</span><span>${percent}%</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${percent}%; background:${gradient}"></div></div></div>
                `;
                card.onclick = () => Router.openFolder(f);
                mount.appendChild(card);
            });
        },
        renderList: (filterText = '') => {
            const f = QuantumApp.state.folder;
            const listToday = document.getElementById('list-today');
            const listLong = document.getElementById('list-longterm');
            listToday.innerHTML = ''; listLong.innerHTML = '';
            const data = DB.get().tasks.filter(t => t.folder === f);
            if(data.length === 0) { listToday.innerHTML = `<div style="text-align:center; padding:3rem; color:var(--text-muted); opacity:0.5;">Empty Sector.</div>`; return; }
            data.forEach((t, i) => {
                if(filterText && !t.title.toLowerCase().includes(filterText.toLowerCase())) return;
                const el = document.createElement('div');
                el.className = `task-item ${t.completed ? 'completed' : ''} interactive`;
                el.style.animationDelay = `${i * 0.05}s`;
                el.onclick = () => Modal.edit(t.id);
                el.innerHTML = `
                    <div class="checkbox" onclick="event.stopPropagation(); Tasks.toggle(${t.id})">${t.completed ? '✓' : ''}</div>
                    <div style="flex:1;">
                        <h4 style="font-weight:500;">${t.title}</h4>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            ${t.urgent ? `<span class="tag urgent">PRIORITY</span>` : ''}
                            <span class="tag">${Tasks.getFormattedDate(t.dueDate)}</span>
                            <span class="tag" style="opacity:0.7;">${t.time || ''}</span>
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); Tasks.delete(${t.id})" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:1.2rem;">×</button>
                `;
                if(t.type === 'today') listToday.appendChild(el); else listLong.appendChild(el);
            });
        },
        save: () => {
            const title = document.getElementById('inp-title').value;
            const dueDate = document.getElementById('inp-date').value;
            if(!title || !dueDate) return NotificationSys.show('Validation Error', 'error');
            const taskData = {
                title, dueDate,
                folder: document.getElementById('inp-folder').value,
                type: document.getElementById('inp-type').value,
                time: document.getElementById('inp-time').value,
                urgent: document.getElementById('inp-urgent').checked
            };
            let db = DB.get();
            if (QuantumApp.state.editingId) {
                const idx = db.tasks.findIndex(t => t.id === QuantumApp.state.editingId);
                if (idx !== -1) db.tasks[idx] = { ...db.tasks[idx], ...taskData };
            } else {
                db.tasks.push({ id: Date.now(), completed: false, ...taskData });
            }
            db.tasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            DB.set(db);
            Tasks.updateGlobalStats();
            Modal.close();
            QuantumApp.state.folder ? Tasks.renderList() : Tasks.renderFolders();
        },
        toggle: (id) => {
            const db = DB.get(); const t = db.tasks.find(x => x.id === id);
            if(t) { t.completed = !t.completed; DB.set(db); Tasks.renderList(); Tasks.updateGlobalStats(); if(t.completed) FX.confetti(); }
        },
        delete: (id) => {
            if(!confirm('Purge mission?')) return;
            let db = DB.get(); db.tasks = db.tasks.filter(x => x.id !== id); DB.set(db);
            Tasks.renderList(); Tasks.updateGlobalStats(); Modal.close();
        },
        search: (val) => Tasks.renderList(val)
    };

    const Calendar = {
        date: new Date(),
        nav: (delta) => {
            delta === 0 ? Calendar.date = new Date() : Calendar.date.setMonth(Calendar.date.getMonth() + delta);
            Calendar.render();
        },
        render: () => {
            const grid = document.getElementById('cal-grid-mount'); if(!grid) return;
            grid.innerHTML = '';
            const y = Calendar.date.getFullYear(), m = Calendar.date.getMonth();
            const todayStr = new Date().toISOString().split('T')[0];
            const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            document.getElementById('cal-title').innerText = `${monthNames[m]} ${y}`;
            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => grid.innerHTML += `<div class="cal-day-name">${d}</div>`);
            const firstDay = new Date(y, m, 1).getDay(), daysInMonth = new Date(y, m + 1, 0).getDate();
            const dbTasks = DB.get().tasks;
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="cal-cell empty"></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const isToday = dateStr === todayStr;
                const dayTasks = dbTasks.filter(t => t.dueDate === dateStr);
                let taskHTML = '';
                dayTasks.forEach(t => taskHTML += `<div class="task-dot ${t.completed?'done':t.urgent?'urgent':''}">${t.title}</div>`);
                grid.innerHTML += `<div class="cal-cell ${isToday?'today':''}" onclick="NotificationSys.show('${dayTasks.length} missions')"><div class="cal-date-num">${d}</div>${taskHTML}</div>`;
            }
        }
    };

    const Modal = {
        open: () => {
            QuantumApp.state.editingId = null;
            Modal.renderCommon();
            document.querySelector('.modal-window h2').innerText = 'New Objective';
            document.getElementById('inp-title').value = '';
            document.getElementById('inp-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('modal-overlay').classList.add('open');
        },
        edit: (id) => {
            const task = DB.get().tasks.find(t => t.id === id); if(!task) return;
            QuantumApp.state.editingId = id;
            Modal.renderCommon();
            document.querySelector('.modal-window h2').innerText = 'Edit Objective';
            document.getElementById('inp-title').value = task.title;
            document.getElementById('inp-folder').value = task.folder;
            document.getElementById('inp-date').value = task.dueDate;
            document.getElementById('inp-time').value = task.time;
            document.getElementById('inp-urgent').checked = task.urgent;
            document.getElementById('modal-overlay').classList.add('open');
        },
        close: () => document.getElementById('modal-overlay').classList.remove('open'),
        renderCommon: () => {
            const sel = document.getElementById('inp-folder'); sel.innerHTML = '';
            Tasks.folders.forEach(f => sel.innerHTML += `<option value="${f}">${f}</option>`);
            if(QuantumApp.state.folder) sel.value = QuantumApp.state.folder;
        }
    };

    /**
     * ==========================================
     * QUANTUM EXTENSIONS (Merged Logic)
     * ==========================================
     */
    const QuantumExtensions = {
        init: () => {
            // Inject My Day Button
            const navContainer = document.querySelector('aside');
            
            // Create My Day Item with text span
            const myDayBtn = document.createElement('div');
            myDayBtn.className = 'nav-item';
            myDayBtn.setAttribute('data-tooltip', 'My Day');
            myDayBtn.onclick = () => Router.nav('myday');
            myDayBtn.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <span class="nav-text">My Day</span>
            `;
            
            // Insert at index 3 (After Calendar)
            // Current Children: 0:LogoDiv, 1:Home, 2:Calendar, 3:Sync...
            navContainer.insertBefore(myDayBtn, navContainer.children[3]);

            // Inject Excel Controls with text spans
            const excelExportBtn = document.createElement('div');
            excelExportBtn.className = 'nav-item';
            excelExportBtn.style.color = '#1D6F42';
            excelExportBtn.setAttribute('data-tooltip', 'Export Excel');
            excelExportBtn.onclick = () => QuantumExcel.export();
            excelExportBtn.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                <span class="nav-text">Export</span>
            `;
            
            const excelImportBtn = document.createElement('div');
            excelImportBtn.className = 'nav-item';
            excelImportBtn.style.color = '#1D6F42';
            excelImportBtn.setAttribute('data-tooltip', 'Import Excel');
            excelImportBtn.onclick = () => document.getElementById('excel-import-file').click();
            excelImportBtn.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="12" y2="12"></line><line x1="15" y1="15" x2="12" y2="12"></line></svg>
                <span class="nav-text">Import</span>
            `;

            // Insert before JSON Backup (which is usually around index 5 or 6 now)
            // Easier approach: Insert before the element that has onclick="DataSync.export()"
            const jsonBackupBtn = document.querySelector('div[onclick="DataSync.export()"]');
            navContainer.insertBefore(excelExportBtn, jsonBackupBtn);
            navContainer.insertBefore(excelImportBtn, jsonBackupBtn);

            // Inject My Day View
            const main = document.querySelector('main');
            const myDayView = document.createElement('div');
            myDayView.id = 'view-myday';
            myDayView.className = 'view-container';
            myDayView.innerHTML = `
                <div class="task-view-header">
                    <h1 style="font-weight:800; font-size:2rem; background: linear-gradient(135deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">My Day</h1>
                    <div style="margin-left:auto; color:var(--text-muted);">Master Basel's Agenda</div>
                </div>
                <div id="myday-list-mount" style="padding-bottom:100px;"></div>
            `;
            main.appendChild(myDayView);

            // Override Router
            const originalNav = Router.nav;
            Router.nav = (view) => {
                if (view === 'myday') {
                    document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    document.getElementById('view-myday').classList.add('active');
                    myDayBtn.classList.add('active');
                    MyDayController.render();
                } else {
                    originalNav(view);
                }
            };
            // Override Calendar
            Calendar.render = ExtendedCalendar.render;
        }
    };

    const QuantumExcel = {
        export: () => {
            const tasks = DB.get().tasks;
            if (tasks.length === 0) return NotificationSys.show('No data to export', 'error');
            let csvContent = "data:text/csv;charset=utf-8,ID,Title,Folder,Date,Time,Priority,Status,Type\n";
            tasks.forEach(function(rowArray) {
                let row = `${rowArray.id},"${rowArray.title.replace(/"/g, '""')}",${rowArray.folder},${rowArray.dueDate},${rowArray.time || ''},${rowArray.urgent ? 'High' : 'Normal'},${rowArray.completed ? 'Completed' : 'Pending'},${rowArray.type}`;
                csvContent += row + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Basel_Tasks_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            NotificationSys.show('Excel File (CSV) Generated', 'success');
        },
        import: (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n').slice(1);
                const currentDB = DB.get();
                let addedCount = 0;
                rows.forEach(row => {
                    if (row && row.trim().length > 0) {
                        const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || row.split(',');
                        if (cols && cols.length >= 4) {
                            const title = cols[1].replace(/^"|"$/g, '').replace(/""/g, '"');
                            const newTask = {
                                id: Date.now() + Math.floor(Math.random() * 1000),
                                title: title,
                                folder: cols[2] || 'Personal',
                                dueDate: cols[3],
                                time: cols[4] || '',
                                urgent: (cols[5] && cols[5].includes('High')),
                                completed: (cols[6] && cols[6].includes('Completed')),
                                type: cols[7] || 'today'
                            };
                            currentDB.tasks.push(newTask);
                            addedCount++;
                        }
                    }
                });
                DB.set(currentDB);
                NotificationSys.show(`Imported ${addedCount} tasks successfully`, 'success');
                setTimeout(() => location.reload(), 1000);
            };
            reader.readAsText(file);
        }
    };

    const MyDayController = {
        render: () => {
            const mount = document.getElementById('myday-list-mount');
            mount.innerHTML = '';
            let tasks = DB.get().tasks;
            tasks.sort((a, b) => {
                const dateA = new Date(a.dueDate + (a.time ? 'T' + a.time : 'T00:00'));
                const dateB = new Date(b.dueDate + (b.time ? 'T' + b.time : 'T00:00'));
                return dateA - dateB;
            });
            if (tasks.length === 0) {
                mount.innerHTML = `<div style="text-align:center; padding:4rem; color:var(--text-muted); opacity:0.6;">You are completely free, Sir.</div>`;
                return;
            }
            tasks.forEach((t, i) => {
                const el = document.createElement('div');
                el.className = `task-item ${t.completed ? 'completed' : ''} interactive`;
                el.style.animation = `slideUp 0.4s ease ${i * 0.05}s backwards`;
                if(t.completed) { el.style.borderColor = 'var(--success)'; el.style.background = 'rgba(0, 219, 181, 0.05)'; }
                el.onclick = () => Modal.edit(t.id);
                el.innerHTML = `
                    <div class="checkbox" onclick="event.stopPropagation(); Tasks.toggle(${t.id}); setTimeout(MyDayController.render, 100)">${t.completed ? '✓' : ''}</div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between;">
                            <h4 style="font-weight:500;">${t.title}</h4>
                            <span style="font-size:0.7rem; opacity:0.6; border:1px solid var(--glass-border); padding:2px 6px; border-radius:4px;">${t.folder}</span>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            ${t.urgent ? `<span class="tag urgent">URGENT</span>` : ''}
                            <span class="tag" style="background:var(--primary-glow);">${Tasks.getFormattedDate(t.dueDate)}</span>
                            ${t.time ? `<span class="tag">${t.time}</span>` : ''}
                        </div>
                    </div>
                `;
                mount.appendChild(el);
            });
        }
    };

    const ExtendedCalendar = {
        render: () => {
            const grid = document.getElementById('cal-grid-mount'); if(!grid) return;
            grid.innerHTML = '';
            const date = Calendar.date; 
            const y = date.getFullYear(), m = date.getMonth();
            const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            document.getElementById('cal-title').innerText = `${monthNames[m]} ${y}`;
            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => grid.innerHTML += `<div class="cal-day-name">${d}</div>`);
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const dbTasks = DB.get().tasks;
            const todayStr = new Date().toISOString().split('T')[0];
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="cal-cell empty"></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const isToday = dateStr === todayStr;
                const dayTasks = dbTasks.filter(t => t.dueDate === dateStr);
                let taskHTML = '';
                dayTasks.forEach(t => {
                    taskHTML += `<div class="task-dot ${t.completed?'done':t.urgent?'urgent':''}" onclick="event.stopPropagation(); Modal.edit(${t.id});" style="cursor:pointer;">${t.title}</div>`;
                });
                const cell = document.createElement('div');
                cell.className = `cal-cell ${isToday?'today':''}`;
                cell.onclick = () => ExtendedCalendar.openAddModal(dateStr);
                cell.innerHTML = `<div class="cal-date-num">${d}</div>${taskHTML}`;
                grid.appendChild(cell);
            }
        },
        openAddModal: (dateStr) => {
            Modal.open(); 
            setTimeout(() => {
                document.getElementById('inp-date').value = dateStr;
                document.querySelector('.modal-window h2').innerText = `New Mission: ${dateStr}`;
            }, 50);
        }
    };

    QuantumExtensions.init();
</script>
</body>
</html>
